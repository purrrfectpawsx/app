import { Page, expect } from '@playwright/test';

/**
 * Auth Utilities for E2E Tests
 *
 * Helper functions for common authentication flows used across tests.
 */

export interface SignupCredentials {
  name: string;
  email: string;
  password: string;
}

export interface LoginCredentials {
  email: string;
  password: string;
  rememberMe?: boolean;
}

/**
 * Sign up a new user with email/password
 *
 * @param page - Playwright page object
 * @param credentials - User signup credentials
 */
export async function signUp(page: Page, credentials: SignupCredentials): Promise<void> {
  await page.goto('/signup');

  // Fill signup form
  await page.getByLabel(/name/i).fill(credentials.name);
  await page.getByLabel(/email/i).fill(credentials.email);
  await page.getByLabel(/^password$/i).fill(credentials.password);
  await page.getByLabel(/confirm password/i).fill(credentials.password);

  // Submit form
  await page.getByRole('button', { name: /create account/i }).click();

  // In test environment with mocked auth, users are auto-verified
  // and may redirect directly to dashboard/pets page instead of verify-email
  // Wait for either verify-email page OR dashboard/pets page (for auto-verified users)
  await Promise.race([
    expect(page).toHaveURL(/\/verify-email/, { timeout: 5000 }).catch(() => {}),
    expect(page).toHaveURL(/\/(dashboard|pets)/, { timeout: 5000 }).catch(() => {})
  ]);

  // Give the page a moment to stabilize
  await page.waitForLoadState('networkidle', { timeout: 10000 });
}

/**
 * Log in an existing user with email/password
 *
 * @param page - Playwright page object
 * @param credentials - User login credentials
 */
export async function login(page: Page, credentials: LoginCredentials): Promise<void> {
  // Check if user is already logged in (e.g., after auto-verified signup)
  const currentUrl = page.url();
  if (currentUrl.includes('/pets') || currentUrl.includes('/dashboard')) {
    // Already logged in, no need to go through login flow
    return;
  }

  await page.goto('/login');

  // Wait for navigation to complete
  await page.waitForLoadState('load', { timeout: 10000 });

  // If already logged in, might redirect immediately to /pets or /dashboard
  // Check URL after navigation
  const urlAfterGoto = page.url();
  if (urlAfterGoto.includes('/pets') || urlAfterGoto.includes('/dashboard')) {
    // Already logged in, redirected from /login
    return;
  }

  // Fill login form
  await page.getByLabel(/email/i).fill(credentials.email);
  await page.getByLabel(/password/i).fill(credentials.password);

  // Handle "Remember me" checkbox if specified
  if (credentials.rememberMe !== undefined) {
    const checkbox = page.getByLabel(/remember me/i);
    if (credentials.rememberMe) {
      await checkbox.check();
    } else {
      await checkbox.uncheck();
    }
  }

  // Submit form
  await page.getByRole('button', { name: /sign in/i }).click();

  // Wait for redirect to pets page (dashboard redirects to /pets)
  await expect(page).toHaveURL(/\/(dashboard|pets)/);
}

/**
 * Log out the current user
 *
 * @param page - Playwright page object
 */
export async function logout(page: Page): Promise<void> {
  // Click logout button in header
  await page.getByRole('button', { name: /logout/i }).click();

  // Wait for redirect to login page
  await expect(page).toHaveURL(/\/login/);
}

/**
 * Create a unique test email address
 *
 * @param prefix - Email prefix (default: 'test')
 * @returns Unique email address with timestamp
 */
export function generateTestEmail(prefix: string = 'test'): string {
  const timestamp = Date.now();
  return `${prefix}+${timestamp}@example.com`;
}

/**
 * Generate a valid test password
 *
 * @returns Password meeting validation requirements (8+ chars, 1 uppercase, 1 number)
 */
export function generateTestPassword(): string {
  return 'TestPass123';
}

/**
 * Wait for auth state to be ready (user logged in)
 *
 * @param page - Playwright page object
 */
export async function waitForAuthReady(page: Page): Promise<void> {
  // Wait for auth context to initialize by checking for logout button
  await expect(page.getByRole('button', { name: /logout/i })).toBeVisible({ timeout: 10000 });
}

/**
 * Assert user is on login page
 *
 * @param page - Playwright page object
 */
export async function expectLoginPage(page: Page): Promise<void> {
  await expect(page).toHaveURL(/\/login/);
  await expect(page.getByRole('heading', { name: /welcome back/i })).toBeVisible();
}

/**
 * Assert user is on dashboard/pets page
 *
 * @param page - Playwright page object
 */
export async function expectDashboardPage(page: Page): Promise<void> {
  await expect(page).toHaveURL(/\/(dashboard|pets)/);
  await expect(page.getByRole('heading', { name: /(dashboard|my pets)/i })).toBeVisible();
}

/**
 * Assert user is authenticated (logout button visible)
 *
 * @param page - Playwright page object
 */
export async function expectAuthenticated(page: Page): Promise<void> {
  await expect(page.getByRole('button', { name: /logout/i })).toBeVisible();
}

/**
 * Assert user is NOT authenticated (logout button not visible)
 *
 * @param page - Playwright page object
 */
export async function expectNotAuthenticated(page: Page): Promise<void> {
  await expect(page.getByRole('button', { name: /logout/i })).not.toBeVisible();
}

/**
 * Authenticate a test user (signup + auto-verify in one step)
 * This is the preferred method for test setup in mocked environments
 * where users are auto-verified. Use this instead of calling signUp() and login() separately.
 *
 * @param page - Playwright page object
 * @param credentials - User signup credentials
 */
export async function authenticateTestUser(page: Page, credentials: SignupCredentials): Promise<void> {
  // Navigate to signup
  await page.goto('/signup');

  // Fill and submit signup form
  await page.getByLabel(/name/i).fill(credentials.name);
  await page.getByLabel(/email/i).fill(credentials.email);
  await page.getByLabel(/^password$/i).fill(credentials.password);
  await page.getByLabel(/confirm password/i).fill(credentials.password);
  await page.getByRole('button', { name: /create account/i }).click();

  // Wait for any navigation (verify-email, dashboard, or pets)
  await page.waitForURL(/(verify-email|dashboard|pets)/, { timeout: 15000 });

  // If not on dashboard/pets yet, navigate there
  // In mocked tests with auto-verification, this should work immediately
  const currentUrl = page.url();
  if (!currentUrl.includes('/dashboard') && !currentUrl.includes('/pets')) {
    await page.goto('/pets');
  }

  // Wait for page to be fully loaded and authenticated
  await page.waitForLoadState('networkidle', { timeout: 10000 });

  // Verify authentication by checking for logout button
  await expect(page.getByRole('button', { name: /logout/i })).toBeVisible({ timeout: 10000 });
}

/**
 * Helper: Inject mock auth session into browser localStorage
 * This ensures the Supabase client recognizes the user as authenticated
 */
async function injectAuthSession(page: Page, user: any, accessToken: string, refreshToken: string) {
  await page.evaluate(
    ({ user, accessToken, refreshToken }) => {
      const session = {
        access_token: accessToken,
        refresh_token: refreshToken,
        expires_in: 3600,
        expires_at: Math.floor(Date.now() / 1000) + 3600,
        token_type: 'bearer',
        user,
      };

      // Set session in localStorage (Supabase's default storage)
      const storageKey = 'sb-' + window.location.hostname.split('.')[0] + '-auth-token';
      localStorage.setItem(storageKey, JSON.stringify(session));

      // Also set in a generic key that Supabase might use
      localStorage.setItem('supabase.auth.token', JSON.stringify(session));
    },
    { user, accessToken, refreshToken }
  );
}
