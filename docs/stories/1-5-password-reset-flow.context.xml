<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>Password Reset Flow</title>
    <status>drafted</status>
    <generatedAt>2025-11-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-5-password-reset-flow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user who forgot my password</asA>
    <iWant>to reset it via email</iWant>
    <soThat>I can regain access to my account</soThat>
    <tasks>
      <task id="1" acs="1,2,3">
        <description>Create ForgotPasswordForm component</description>
        <subtasks>
          <subtask>Create src/components/auth/ForgotPasswordForm.tsx</subtask>
          <subtask>Add email input field with validation (required, valid email format)</subtask>
          <subtask>Add "Send Reset Link" submit button</subtask>
          <subtask>Implement Supabase auth.resetPasswordForEmail() call</subtask>
          <subtask>Show success message after submission (regardless of email existence)</subtask>
          <subtask>Handle loading state during email send</subtask>
          <subtask>Add error handling for network failures</subtask>
        </subtasks>
      </task>
      <task id="2" acs="1">
        <description>Create ForgotPassword page</description>
        <subtasks>
          <subtask>Create src/pages/ForgotPassword.tsx</subtask>
          <subtask>Use AuthLayout component for consistent auth page design</subtask>
          <subtask>Add ForgotPasswordForm component</subtask>
          <subtask>Add "Back to Login" link</subtask>
          <subtask>Add route /forgot-password to App.tsx</subtask>
        </subtasks>
      </task>
      <task id="3" acs="1">
        <description>Add "Forgot Password?" link to LoginForm</description>
        <subtasks>
          <subtask>Update src/components/auth/LoginForm.tsx</subtask>
          <subtask>Add link below password field</subtask>
          <subtask>Link navigates to /forgot-password route</subtask>
          <subtask>Style link consistently with existing auth forms</subtask>
        </subtasks>
      </task>
      <task id="4" acs="3,4">
        <description>Configure Supabase password reset email</description>
        <subtasks>
          <subtask>Customize password reset email template in Supabase Auth settings</subtask>
          <subtask>Add PetLog branding to email</subtask>
          <subtask>Verify reset link format: includes token and redirects to /reset-password</subtask>
          <subtask>Set token expiration to 1 hour</subtask>
          <subtask>Test email delivery time (&lt;60 seconds)</subtask>
        </subtasks>
      </task>
      <task id="5" acs="5,6,7,8">
        <description>Create ResetPasswordForm component</description>
        <subtasks>
          <subtask>Create src/components/auth/ResetPasswordForm.tsx</subtask>
          <subtask>Add new password field (password type input)</subtask>
          <subtask>Add confirm password field</subtask>
          <subtask>Implement password validation: minimum 8 characters, 1 uppercase, 1 number</subtask>
          <subtask>Add password mismatch validation</subtask>
          <subtask>Show real-time validation feedback</subtask>
          <subtask>Implement Supabase auth.updateUser({ password: newPassword })</subtask>
          <subtask>Handle successful reset: show success message, auto-login</subtask>
          <subtask>Handle errors (expired token, invalid token, network failure)</subtask>
        </subtasks>
      </task>
      <task id="6" acs="5">
        <description>Create ResetPassword page</description>
        <subtasks>
          <subtask>Create src/pages/ResetPassword.tsx</subtask>
          <subtask>Use AuthLayout component</subtask>
          <subtask>Add ResetPasswordForm component</subtask>
          <subtask>Extract reset token from URL query parameters</subtask>
          <subtask>Handle invalid/missing token with error message</subtask>
          <subtask>Add route /reset-password to App.tsx</subtask>
          <subtask>Redirect to dashboard after successful reset and auto-login</subtask>
        </subtasks>
      </task>
      <task id="7" acs="9">
        <description>Configure password change confirmation email</description>
        <subtasks>
          <subtask>Verify Supabase sends confirmation email automatically</subtask>
          <subtask>Customize confirmation email template in Supabase Auth settings</subtask>
          <subtask>Add PetLog branding to confirmation email</subtask>
          <subtask>Include security message: "If you didn't make this change, contact support"</subtask>
          <subtask>Test confirmation email is sent after password reset</subtask>
        </subtasks>
      </task>
      <task id="8" acs="all">
        <description>Testing and validation</description>
        <subtasks>
          <subtask>Test forgot password flow with valid email (existing user)</subtask>
          <subtask>Test forgot password flow with non-existent email (should still show success)</subtask>
          <subtask>Test reset email is received within 60 seconds</subtask>
          <subtask>Test reset link opens reset password page</subtask>
          <subtask>Test password validation (min 8 chars, 1 uppercase, 1 number)</subtask>
          <subtask>Test password mismatch validation</subtask>
          <subtask>Test successful password reset and auto-login</subtask>
          <subtask>Test old password no longer works after reset</subtask>
          <subtask>Test confirmation email is sent after reset</subtask>
          <subtask>Test expired reset token (after 1 hour)</subtask>
          <subtask>Test invalid reset token</subtask>
          <subtask>Test network error handling</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">"Forgot Password?" link visible on login page</criterion>
    <criterion id="2">Forgot password form accepts email address</criterion>
    <criterion id="3">Reset email sent within 60 seconds (even if email doesn't exist - security)</criterion>
    <criterion id="4">Email contains branded message and secure reset link (valid 1 hour)</criterion>
    <criterion id="5">Reset link opens form to enter new password (with confirmation)</criterion>
    <criterion id="6">New password validated (same rules as signup)</criterion>
    <criterion id="7">Successful reset invalidates old password immediately</criterion>
    <criterion id="8">User automatically logged in after successful reset</criterion>
    <criterion id="9">Notification email sent confirming password change</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 1: Foundation &amp; Authentication</title>
        <section>Story 1.5: Password Reset Flow</section>
        <snippet>Password reset flow allows users who forgot their password to reset it via email. Reset email sent within 60 seconds with branded message and secure reset link (valid 1 hour). Successful reset invalidates old password immediately and auto-logs user in.</snippet>
      </doc>
      <doc>
        <path>docs/stories/1-1-user-registration-with-email-password.md</path>
        <title>Story 1.1: User Registration</title>
        <section>Password Validation Rules</section>
        <snippet>Password validation enforces: minimum 8 characters, 1 uppercase, 1 number. Zod schema defined in src/schemas/auth.ts. React Hook Form integration for real-time validation feedback.</snippet>
      </doc>
      <doc>
        <path>docs/stories/1-3-user-login-with-email-password.md</path>
        <title>Story 1.3: User Login</title>
        <section>Authentication Flow</section>
        <snippet>Login uses Supabase auth.signInWithPassword(). Session persistence managed by AuthContext. Generic error messages for security (no hint which credential is wrong). Rate limiting prevents brute force (5 failed attempts).</snippet>
      </doc>
      <doc>
        <path>docs/stories/1-4-google-oauth-integration.md</path>
        <title>Story 1.4: Google OAuth Integration</title>
        <section>Auth Patterns and Components</section>
        <snippet>Reusable AuthLayout component for consistent auth page design. AuthContext pattern for centralized auth state. Auto-login pattern after successful OAuth with redirect to dashboard. Environment-based logging for error handling.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/components/auth/LoginForm.tsx</path>
        <kind>component</kind>
        <symbol>LoginForm</symbol>
        <lines>1-150</lines>
        <reason>Existing login form where "Forgot Password?" link needs to be added. Shows form patterns, error handling, and React Hook Form integration to follow.</reason>
      </artifact>
      <artifact>
        <path>src/components/auth/AuthLayout.tsx</path>
        <kind>component</kind>
        <symbol>AuthLayout</symbol>
        <lines>1-47</lines>
        <reason>Reusable auth page wrapper with consistent branding. Must be used for ForgotPassword and ResetPassword pages.</reason>
      </artifact>
      <artifact>
        <path>src/contexts/AuthContext.tsx</path>
        <kind>context</kind>
        <symbol>AuthContext, useAuth</symbol>
        <lines>1-167</lines>
        <reason>Centralized auth state management. Provides signIn, signOut methods. May need to add password reset methods here or use Supabase directly in components.</reason>
      </artifact>
      <artifact>
        <path>src/schemas/auth.ts</path>
        <kind>schema</kind>
        <symbol>signupSchema, loginSchema</symbol>
        <lines>1-28</lines>
        <reason>Existing Zod validation schemas. Password validation rules defined here (min 8 chars, 1 uppercase, 1 number). Must create similar schemas for password reset forms.</reason>
      </artifact>
      <artifact>
        <path>src/lib/supabase.ts</path>
        <kind>service</kind>
        <symbol>supabase, BrowserStorageAdapter</symbol>
        <lines>1-43</lines>
        <reason>Supabase client with custom storage adapter. Use for auth.resetPasswordForEmail() and auth.updateUser() calls.</reason>
      </artifact>
      <artifact>
        <path>src/App.tsx</path>
        <kind>config</kind>
        <symbol>App</symbol>
        <lines>1-48</lines>
        <reason>Main routing configuration. Need to add /forgot-password and /reset-password routes here.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="react" version="^18.2.0" />
        <package name="react-dom" version="^18.2.0" />
        <package name="@supabase/supabase-js" version="^2.38.0" />
        <package name="react-hook-form" version="^7.48.0" />
        <package name="zod" version="^3.22.0" />
        <package name="@hookform/resolvers" version="^3.3.0" />
        <package name="react-router-dom" version="^6.20.0" />
        <package name="lucide-react" version="^0.294.0" />
        <package name="@radix-ui/react-checkbox" version="^1.3.3" />
        <package name="@radix-ui/react-label" version="^2.0.2" />
        <package name="@radix-ui/react-slot" version="^1.0.2" />
        <package name="class-variance-authority" version="^0.7.0" />
        <package name="clsx" version="^2.0.0" />
        <package name="tailwind-merge" version="^2.1.0" />
      </node>
      <framework name="Vite" version="^5.0.0" />
      <framework name="TypeScript" version="^5.2.2" />
      <framework name="Tailwind CSS" version="^3.3.0" />
      <framework name="shadcn/ui" description="Radix UI + Tailwind CSS components" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use React Hook Form + Zod for all form validation (established pattern from Stories 1.1-1.4)</constraint>
    <constraint>Use AuthLayout component for consistent auth page design</constraint>
    <constraint>Follow existing error handling patterns from LoginForm (generic security messages, network error handling)</constraint>
    <constraint>Reuse password validation schema from src/schemas/auth.ts (min 8 chars, 1 uppercase, 1 number)</constraint>
    <constraint>Use shadcn/ui components for UI consistency (Button, Input, Label, Card)</constraint>
    <constraint>Show success message even for non-existent emails (security - prevent email enumeration)</constraint>
    <constraint>Environment-based logging only (import.meta.env.DEV checks for console.log/error)</constraint>
    <constraint>Auto-login after successful password reset (follow OAuth auto-login pattern from Story 1.4)</constraint>
    <constraint>Generic error messages for security (don't leak implementation details)</constraint>
    <constraint>Extract reset token from URL query parameters using react-router-dom's useSearchParams</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>supabase.auth.resetPasswordForEmail()</name>
      <kind>Supabase API</kind>
      <signature>resetPasswordForEmail(email: string, options?: { redirectTo?: string }): Promise&lt;{ data, error }&gt;</signature>
      <path>src/lib/supabase.ts</path>
    </interface>
    <interface>
      <name>supabase.auth.updateUser()</name>
      <kind>Supabase API</kind>
      <signature>updateUser(attributes: { password?: string }): Promise&lt;{ data: { user }, error }&gt;</signature>
      <path>src/lib/supabase.ts</path>
    </interface>
    <interface>
      <name>AuthLayout</name>
      <kind>React Component</kind>
      <signature>&lt;AuthLayout title="string" description?="string"&gt;{children}&lt;/AuthLayout&gt;</signature>
      <path>src/components/auth/AuthLayout.tsx</path>
    </interface>
    <interface>
      <name>useAuth hook</name>
      <kind>React Hook</kind>
      <signature>{ user, session, loading, signIn, signOut, signUp, resendVerificationEmail, isEmailVerified }</signature>
      <path>src/contexts/AuthContext.tsx</path>
    </interface>
    <interface>
      <name>useNavigate</name>
      <kind>React Router Hook</kind>
      <signature>navigate(path: string, options?: { replace?: boolean })</signature>
      <path>react-router-dom</path>
    </interface>
    <interface>
      <name>useSearchParams</name>
      <kind>React Router Hook</kind>
      <signature>[searchParams, setSearchParams] where searchParams.get(key) returns query param value</signature>
      <path>react-router-dom</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Manual testing is the current standard for this project (no automated test framework configured yet, as noted in Stories 1.1-1.4). Testing should cover all acceptance criteria with manual verification. Document test scenarios and results in the story completion notes. Future stories may introduce automated testing with Vitest or React Testing Library.</standards>
    <locations>No automated test directory exists yet. Manual testing performed via dev server (npm run dev) and Supabase dashboard for email verification.</locations>
    <ideas>
      <idea ac="1">Verify "Forgot Password?" link is visible on login page and navigates to /forgot-password</idea>
      <idea ac="2">Test ForgotPasswordForm accepts email input and validates email format</idea>
      <idea ac="3">Test reset email is sent within 60 seconds for existing user</idea>
      <idea ac="3">Test reset email shows success message even for non-existent email (security test - no email enumeration)</idea>
      <idea ac="4">Verify reset email contains PetLog branding and valid reset link</idea>
      <idea ac="4">Test reset link contains token and redirects to /reset-password</idea>
      <idea ac="4">Test reset token expires after 1 hour (wait 1+ hour, verify expired token error)</idea>
      <idea ac="5">Test reset link opens ResetPasswordForm with password and confirm password fields</idea>
      <idea ac="6">Test password validation: min 8 characters required</idea>
      <idea ac="6">Test password validation: at least 1 uppercase letter required</idea>
      <idea ac="6">Test password validation: at least 1 number required</idea>
      <idea ac="6">Test password mismatch validation shows error</idea>
      <idea ac="7">Test successful password reset invalidates old password immediately</idea>
      <idea ac="7">Verify old password no longer works after reset (test login with old password)</idea>
      <idea ac="8">Test user is automatically logged in after successful password reset</idea>
      <idea ac="8">Verify redirect to /dashboard after successful reset</idea>
      <idea ac="9">Verify confirmation email is sent after password change</idea>
      <idea ac="9">Test confirmation email contains security warning message</idea>
      <idea ac="all">Test network error handling (disconnect internet, verify error message)</idea>
      <idea ac="all">Test invalid/malformed reset token shows appropriate error</idea>
      <idea ac="all">Test loading states appear during email send and password update</idea>
      <idea ac="all">Test form validation provides real-time feedback</idea>
    </ideas>
  </tests>
</story-context>
