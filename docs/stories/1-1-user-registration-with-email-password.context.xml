<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.1</storyId>
    <title>User Registration with Email/Password</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-1-user-registration-with-email-password.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a pet owner</asA>
    <iWant>to create an account using my email and password</iWant>
    <soThat>I can securely access my pet's data from any device</soThat>
    <tasks>
- Task 1: Set up Supabase project and initialize client (AC: #4)
  - Create Supabase project or use existing
  - Install @supabase/supabase-js package
  - Create src/lib/supabase.ts with client configuration
  - Set up environment variables for Supabase URL and anon key

- Task 2: Create profiles table with RLS policies (AC: #4)
  - Write SQL migration for profiles table (id, email, name, created_at, subscription_tier)
  - Create RLS policy: users can only read/write their own profile
  - Set up foreign key constraint to auth.users table
  - Test RLS policies work correctly

- Task 3: Create authentication context (AC: #4, #5)
  - Create src/contexts/AuthContext.tsx with auth state
  - Implement useAuth hook for consuming context
  - Handle Supabase auth state changes (onAuthStateChange)
  - Provide auth methods: signUp, signIn, signOut

- Task 4: Create Zod validation schema (AC: #2, #6)
  - Create src/schemas/auth.ts
  - Define signupSchema with email, password, confirmPassword, name
  - Add password rules: min 8 chars, 1 uppercase, 1 number
  - Add email format validation
  - Add password confirmation matching validation

- Task 5: Build SignupForm component (AC: #1, #2, #6)
  - Create src/components/auth/SignupForm.tsx
  - Integrate React Hook Form with Zod schema
  - Add form fields: email, password, confirmPassword, name
  - Implement real-time validation feedback
  - Add loading state during submission
  - Style with Tailwind CSS and shadcn/ui components

- Task 6: Implement signup logic (AC: #3, #4, #5)
  - Call Supabase auth.signUp() on form submission
  - Handle duplicate email error (catch and display)
  - Create profile entry after successful auth signup
  - Redirect to email verification prompt page
  - Display success message

- Task 7: Create AuthLayout component (AC: #1)
  - Create src/components/auth/AuthLayout.tsx
  - Add branding/logo
  - Create responsive layout (centered card on mobile)
  - Add footer with links (terms, privacy)

- Task 8: Create signup page and routing (AC: #1, #5)
  - Create src/pages/SignupPage.tsx
  - Wrap SignupForm in AuthLayout
  - Configure React Router route for /signup
  - Add link to login page ("Already have an account?")

- Task 9: Add error handling and user feedback (AC: #3, #6)
  - Display validation errors inline
  - Show toast/alert for API errors
  - Handle network errors gracefully
  - Add loading spinner during submission

- Task 10: Testing and validation (All ACs)
  - Test successful signup flow
  - Test duplicate email rejection
  - Test password validation rules
  - Test real-time form validation
  - Test redirect to verification prompt
  - Test responsive design on mobile
    </tasks>
  </story>

  <acceptanceCriteria>
1. Signup form displays email, password, confirm password, and name fields
2. Password validation enforces: minimum 8 characters, 1 uppercase, 1 number
3. Duplicate email addresses rejected with clear error message
4. Successful registration creates user in Supabase Auth and profiles table
5. User redirected to email verification prompt after signup
6. Form validation provides real-time feedback (invalid email, password mismatch)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document - FR-1.1: User Registration</title>
        <section>Functional Requirements - User Account Management</section>
        <snippet>Email verification required before accessing core features. Session management with JWT. Email signup flow completes in &lt;60 seconds. Duplicate emails rejected with clear error message.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document - Authentication &amp; Authorization</title>
        <section>Web App Specific Requirements</section>
        <snippet>Authentication methods: Email/Password and Google OAuth. JWT-based sessions with automatic refresh. Protected routes with React Router guards. Row Level Security (RLS) ensures users only access their own data via Supabase RLS policies.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document - NFR-S2: Authentication Security</title>
        <section>Non-Functional Requirements - Security</section>
        <snippet>Passwords hashed with bcrypt via Supabase Auth. JWT tokens expire after 30 days with refresh. Account lockout after 5 failed login attempts. Password reset tokens single-use, expire after 1 hour.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown - Story 1.1: User Registration with Email/Password</title>
        <section>Epic 1: Foundation &amp; Authentication</section>
        <snippet>Components: SignupForm.tsx, AuthLayout.tsx. Supabase: auth.signUp() API. Database: profiles table with id, email, name, created_at, subscription_tier. Validation: React Hook Form + Zod schema. State: Store auth state in React Context (AuthContext.tsx).</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown - Epic 1 Goal</title>
        <section>Epic 1: Foundation &amp; Authentication</section>
        <snippet>Enable secure user access with multiple authentication methods, establishing the foundation for all user-specific features. Without secure authentication, users cannot safely store pet data.</snippet>
      </doc>
    </docs>
    <code>
      <!-- No existing code - this is the foundational story -->
      <note>This is the first story in Epic 1. No existing authentication code to reference. All auth infrastructure will be created by this story.</note>
    </code>
    <dependencies>
      <note>No package.json found yet. Project initialization required. These dependencies will be needed:</note>
      <npm>
        <dependency name="react" version="^18.2.0">Core UI library</dependency>
        <dependency name="react-dom" version="^18.2.0">React DOM renderer</dependency>
        <dependency name="vite" version="^5.0.0">Build tool and dev server</dependency>
        <dependency name="@supabase/supabase-js" version="^2.38.0">Supabase client for auth and database</dependency>
        <dependency name="react-hook-form" version="^7.48.0">Form state management</dependency>
        <dependency name="zod" version="^3.22.0">Schema validation</dependency>
        <dependency name="@hookform/resolvers" version="^3.3.0">React Hook Form + Zod integration</dependency>
        <dependency name="react-router-dom" version="^6.20.0">Client-side routing</dependency>
        <dependency name="tailwindcss" version="^3.3.0">Utility-first CSS framework</dependency>
        <dependency name="@radix-ui/react-*" version="latest">Accessible UI primitives (via shadcn/ui)</dependency>
        <dependency name="lucide-react" version="latest">Icon library for shadcn/ui components</dependency>
        <dependency name="class-variance-authority" version="latest">CSS utility for shadcn/ui</dependency>
        <dependency name="clsx" version="latest">Conditional className utility</dependency>
        <dependency name="tailwind-merge" version="latest">Tailwind class merging utility</dependency>
      </npm>
      <devDependencies>
        <dependency name="@types/react" version="^18.2.0">React TypeScript types</dependency>
        <dependency name="@types/react-dom" version="^18.2.0">React DOM TypeScript types</dependency>
        <dependency name="@vitejs/plugin-react" version="^4.2.0">Vite React plugin</dependency>
        <dependency name="typescript" version="^5.0.0">TypeScript compiler</dependency>
        <dependency name="autoprefixer" version="^10.4.0">PostCSS plugin for Tailwind</dependency>
        <dependency name="postcss" version="^8.4.0">CSS post-processor</dependency>
      </devDependencies>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must use React 18 with Vite as the build tool and development server</constraint>
    <constraint>Must use Supabase BaaS for authentication (auth.signUp API) and database (PostgreSQL)</constraint>
    <constraint>Must use React Hook Form + Zod for form validation with real-time feedback</constraint>
    <constraint>Must use shadcn/ui components (built on Radix UI + Tailwind CSS) for UI</constraint>
    <constraint>Must use Tailwind CSS for all styling (utility-first approach)</constraint>
    <constraint>Must create profiles table with RLS policies: users can only read/write their own profile</constraint>
    <constraint>Password validation: minimum 8 characters, at least 1 uppercase letter, at least 1 number</constraint>
    <constraint>Must handle duplicate email errors with user-friendly message</constraint>
    <constraint>Must redirect to email verification prompt after successful signup</constraint>
    <constraint>Form submission must complete in less than 60 seconds (performance requirement)</constraint>
    <constraint>Must use Context API for global auth state management (AuthContext)</constraint>
    <constraint>Mobile-first responsive design: optimize for 640px+ screens</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>AuthContext</name>
      <kind>React Context API</kind>
      <signature>
interface AuthContextType {
  user: User | null;
  session: Session | null;
  signUp: (email: string, password: string, name: string) =&gt; Promise&lt;void&gt;;
  signIn: (email: string, password: string) =&gt; Promise&lt;void&gt;;
  signOut: () =&gt; Promise&lt;void&gt;;
  loading: boolean;
}
      </signature>
      <path>src/contexts/AuthContext.tsx</path>
    </interface>
    <interface>
      <name>Supabase auth.signUp()</name>
      <kind>API method</kind>
      <signature>
supabase.auth.signUp({
  email: string,
  password: string,
  options?: {
    data?: { name: string }
  }
})
      </signature>
      <path>External: Supabase Auth API</path>
    </interface>
    <interface>
      <name>profiles table schema</name>
      <kind>Database table</kind>
      <signature>
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  name TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  subscription_tier TEXT DEFAULT 'free' CHECK (subscription_tier IN ('free', 'premium'))
);
      </signature>
      <path>Database: Supabase PostgreSQL</path>
    </interface>
    <interface>
      <name>signupSchema (Zod)</name>
      <kind>Validation schema</kind>
      <signature>
const signupSchema = z.object({
  name: z.string().min(1, "Name is required"),
  email: z.string().email("Invalid email address"),
  password: z.string().min(8).regex(/[A-Z]/).regex(/[0-9]/),
  confirmPassword: z.string()
}).refine((data) =&gt; data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"]
});
      </signature>
      <path>src/schemas/auth.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Manual testing is the primary approach for MVP. Testing framework not specified in PRD, but typical React testing stack would include Vitest or Jest with React Testing Library. Focus on manual testing checklist to verify all acceptance criteria. Test both happy path and error scenarios. Verify responsive design on mobile (640px+) and desktop viewports.
    </standards>
    <locations>
      <location>tests/ (recommended, not yet created)</location>
      <location>src/**/*.test.ts (co-located tests, alternative pattern)</location>
      <location>Manual testing via browser for UI/UX validation</location>
    </locations>
    <ideas>
      <testIdea ac="1">Verify signup form renders with all required fields: email, password, confirmPassword, name. Check field types (email input, password inputs hidden). Verify tab order and accessibility.</testIdea>
      <testIdea ac="2">Test password validation rules: Submit with 7 chars (fail), 8+ chars (pass). Submit without uppercase (fail), with uppercase (pass). Submit without number (fail), with number (pass). Verify error messages display correctly.</testIdea>
      <testIdea ac="3">Test duplicate email handling: Create user with email test@example.com. Attempt signup with same email. Verify error message: "An account with this email already exists". Verify link to login page appears.</testIdea>
      <testIdea ac="4">Test successful registration flow: Submit valid form. Mock Supabase auth.signUp() response. Verify user created in auth.users. Verify profile created in profiles table with correct data (id, email, name, subscription_tier='free'). Verify profile.id matches auth user id.</testIdea>
      <testIdea ac="5">Test redirect after signup: Complete successful signup. Verify redirect to email verification prompt page (URL and content). Verify "Check your email" message displays.</testIdea>
      <testIdea ac="6">Test real-time validation: Type invalid email, verify error shows immediately. Type valid email, verify error clears. Type passwords that don't match, verify confirm password error. Type matching passwords, verify error clears. Test all fields update dynamically without form submission.</testIdea>
      <testIdea ac="all">Integration test: Complete full signup flow end-to-end. Verify database state (auth.users and profiles). Test with actual Supabase instance (not mocked). Verify email verification email sent. Test responsive design on mobile viewport (640px width).</testIdea>
      <testIdea ac="all">Error scenarios: Test network error handling (disconnect during signup). Test Supabase service unavailable. Test form submission during loading state (button disabled). Test browser back button after successful signup.</testIdea>
    </ideas>
  </tests>
</story-context>
